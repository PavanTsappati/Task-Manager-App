<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Tasks - Task Manager</title>
    <link rel="stylesheet" href="style.css" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
<div class="sidebar">
    <h2>Task Manager</h2>
    <a href="tasks.html" class="active">Tasks</a>
    <a href="logs.html">Audit Logs</a>
    <button class="btn logout-btn" onclick="logout()">Logout</button>
</div>

<div class="topbar">
    <h1>Tasks</h1>
</div>

<div class="content">

    <div class="create-card">
        <h3>Create Task</h3>
        <label>Title</label>
        <input id="title" maxlength="100" placeholder="Task title (required)" />

        <label>Description</label>
        <textarea id="description" maxlength="500" rows="3" placeholder="Task description (required)"></textarea>

        <button class="btn btn-primary" onclick="createTask()">Create</button>
        <span id="msg" class="error"></span>
    </div>

    <div class="toolbar">
        <input id="search" placeholder="Search tasks..." oninput="onSearch()" />
        <span id="pageInfo"></span>
    </div>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="task-body"></tbody>
    </table>

    <div class="pagination">
        <button class="btn" onclick="prevPage()">Prev</button>
        <button class="btn" onclick="nextPage()">Next</button>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <h2>Edit Task</h2>

        <label class="modal-label">Title</label>
        <input id="editTitle" maxlength="100" class="modal-input"/>

        <label class="modal-label">Description</label>
        <textarea id="editDescription" maxlength="500" rows="4" class="modal-textarea"></textarea>

        <div class="modal-actions">
            <button class="btn btn-primary" onclick="saveEdit()">Save</button>
            <button class="btn" onclick="closeEdit()">Cancel</button>
            <span id="editMsg" class="error"></span>
        </div>
    </div>
</div>

<script src="script.js"></script>

<script>
    let page = 0;
    let searchTimer;
    let currentEditId;

    if (!getAuth()) location.href = "login.html";

    async function loadTasks() {
        const search = document.getElementById("search").value || "";
        const data = await apiGet(`/api/tasks?search=${encodeURIComponent(search)}&page=${page}&size=5`);
        const tbody = document.getElementById("task-body");
        tbody.innerHTML = "";

        if (data.content?.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5">No tasks found.</td></tr>`;
            return;
        }

        data.content.forEach(t => {
            tbody.innerHTML += `
            <tr>
                <td>${t.id}</td>
                <td>${escapeHtml(t.title)}</td>
                <td>${escapeHtml(t.description)}</td>
                <td>${formatDateOnly(t.createdAt)}</td>
                <td>
                    <button class="btn" onclick="openEdit(${t.id}, '${escapeJs(t.title)}', '${escapeJs(t.description)}')">Edit</button>
                    <button class="btn btn-danger" onclick="doDelete(${t.id})">Delete</button>
                </td>
            </tr>`;
        });

        document.getElementById("pageInfo").innerText = `Page ${page+1} of ${data.totalPages}`;
    }

    function escapeJs(str) {
        return String(str).replace(/'/g, "\\'");
    }

    async function createTask() {
        const title = document.getElementById("title").value.trim();
        const desc = document.getElementById("description").value.trim();

        if (!title || !desc) return document.getElementById("msg").innerText = "Fields required.";

        await apiPost("/api/tasks", { title, description: desc });
        document.getElementById("title").value="";
        document.getElementById("description").value="";
        loadTasks();
    }

    function openEdit(id, title, desc) {
        currentEditId = id;
        document.getElementById("editTitle").value = title;
        document.getElementById("editDescription").value = desc;
        document.getElementById("editModal").style.display = "flex";
    }

    function closeEdit() {
        document.getElementById("editModal").style.display = "none";
    }

    async function saveEdit() {
        const title = document.getElementById("editTitle").value.trim();
        const desc = document.getElementById("editDescription").value.trim();

        await apiPut(`/api/tasks/${currentEditId}`, { title, description: desc });
        closeEdit();
        loadTasks();
    }

    async function doDelete(id) {
        if (!confirm("Delete task?")) return;
        await apiDelete(`/api/tasks/${id}`);
        loadTasks();
    }

    function onSearch() {
        clearTimeout(searchTimer);
        searchTimer=setTimeout(()=>{page=0; loadTasks();},300);
    }

    function prevPage() { if(page>0){page--; loadTasks(); } }
    function nextPage() { page++; loadTasks(); }

    function logout() {
        sessionStorage.clear();
        location.href = "login.html";
    }

    loadTasks();
</script>
</body>
</html>
